---
- name: Optimize User Environment
  block:
    - name: Configure Safe Delete Aliases
      lineinfile:
        path: "{{ ansible_user_dir }}/.zshrc"
        line: "{{ item }}"
        create: yes
        state: present
      loop:
        - "# Safe Delete Configuration"
        - "alias rm='gio trash 2>/dev/null || /usr/bin/rm'"
        - "alias rp='/usr/bin/rm'"
- name: Check earlyoom installation state
  raw: "rpm-ostree status | grep -q earlyoom"
  register: earlyoom_check_raw
  failed_when: false
  changed_when: false

- name: Install earlyoom via raw sudo
  raw: "sudo rpm-ostree install earlyoom --apply-live"
  when: "earlyoom_check_raw.rc != 0"
  register: earlyoom_install_raw
  changed_when: "'Added' in earlyoom_install_raw.stdout"

- name: Manage earlyoom service
  raw: "sudo systemctl enable --now earlyoom"
  register: earlyoom_service_raw
  changed_when: "'Created symlink' in earlyoom_service_raw.stdout or 'started' in earlyoom_service_raw.stdout"

- name: Configure earlyoom thresholds
  become: yes
  lineinfile:
    path: /etc/default/earlyoom
    regexp: '^EARLYOOM_ARGS='
    line: 'EARLYOOM_ARGS="-m 5 -s 5 --prefer \"(electron|firefox|chrome|code)\" --avoid \"(gnome-shell|systemd|dbus-daemon)\""'
    state: present
  notify: Restart earlyoom
