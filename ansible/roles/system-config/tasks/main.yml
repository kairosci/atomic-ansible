---
- name: Gather system information for dynamic optimization
  block:
    - name: Get total memory in KB
      shell: cat /proc/meminfo | grep MemTotal | awk '{print $2}'
      register: mem_total_kb
      changed_when: false
      failed_when: false

    - name: Get memory in GB
      set_fact:
        mem_total_gb: "{{ (mem_total_kb.stdout | int / 1024 / 1024) | round | int }}"

    - name: Check if running on laptop (has battery)
      stat:
        path: /sys/class/power_supply/BAT0
      register: battery_check
      changed_when: false
      failed_when: false

- name: Apply system-level configurations
  become: yes
  block:
    - name: Disable unnecessary services
      systemd:
        name: "{{ item }}"
        state: stopped
        enabled: no
      loop:
        - cups.service
        - cups-browsed.service
        - avahi-daemon.service
        - avahi-daemon.socket
        - ModemManager.service
      failed_when: false
      changed_when: true

    - name: Mask unnecessary services
      systemd:
        name: "{{ item }}"
        masked: yes
      loop:
        - geoclue.service
        - tracker-miner-fs-3.service
        - tracker-extract-3.service
      failed_when: false
      changed_when: true

    - name: Configure dynamic sysctl for performance with OOM prevention
      copy:
        dest: /etc/sysctl.d/99-performance.conf
        content: |
          vm.swappiness=10
          vm.vfs_cache_pressure=200
          vm.dirty_ratio=10
          vm.dirty_background_ratio=5
          vm.overcommit_memory=0
          vm.overcommit_ratio=50
          vm.max_map_count=1048576
          vm.admin_reserve_kbytes=262144
          vm.user_reserve_kbytes=524288
          net.core.rmem_max=16777216
          net.core.wmem_max=16777216
          net.ipv4.tcp_fastopen=3
          net.ipv4.tcp_congestion_control=bbr
          net.core.default_qdisc=cake
          fs.file-max=2097152
        mode: '0644'

    - name: Apply sysctl settings
      command: sysctl --system
      changed_when: true
      failed_when: false

    - name: Configure CPU governor
      block:
        - name: Check if cpupower is available
          command: which cpupower
          register: cpupower_check
          changed_when: false
          failed_when: false

        - name: Set CPU governor to performance via cpupower
          command: cpupower frequency-set -g performance
          when: cpupower_check.rc == 0
          changed_when: true
          failed_when: false

        - name: Set CPU governor manually if cpupower unavailable
          shell: |
            for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
              [[ -w "$cpu" ]] && echo "performance" > "$cpu"
            done
          when: cpupower_check.rc != 0
          changed_when: true
          failed_when: false

    - name: Configure I/O scheduler
      block:
        - name: Apply BFQ scheduler to block devices
          shell: |
            for dev in /sys/block/sd* /sys/block/nvme*n*; do
              [[ -w "$dev/queue/scheduler" ]] || continue
              if grep -q "bfq" "$dev/queue/scheduler" 2>/dev/null; then
                echo "bfq" > "$dev/queue/scheduler"
              elif grep -q "mq-deadline" "$dev/queue/scheduler" 2>/dev/null; then
                echo "mq-deadline" > "$dev/queue/scheduler"
              fi
            done
          changed_when: true
          failed_when: false

        - name: Create udev rules for I/O scheduler
          copy:
            dest: /etc/udev/rules.d/60-io-scheduler.rules
            content: |
              ACTION=="add|change", KERNEL=="nvme[0-9]*n[0-9]*", ATTR{queue/scheduler}="bfq"
              ACTION=="add|change", KERNEL=="sd[a-z]*", ATTR{queue/scheduler}="bfq"
            mode: '0644'
          changed_when: true
          failed_when: false

        - name: Reload udev rules
          command: udevadm control --reload-rules
          changed_when: true
          failed_when: false

    - name: Configure TLP dynamically based on system type
      block:
        - name: Check if TLP is installed
          command: which tlp
          register: tlp_check
          changed_when: false
          failed_when: false

        - name: Enable and start TLP (for laptops)
          systemd:
            name: tlp.service
            enabled: yes
            state: started
          when: tlp_check.rc == 0 and battery_check.stat.exists
          changed_when: true
          failed_when: false

        - name: Enable TLP on AC only for desktops
          systemd:
            name: tlp.service
            enabled: yes
          when: tlp_check.rc == 0 and not battery_check.stat.exists
          changed_when: true
          failed_when: false

        - name: Mask rfkill services for TLP
          systemd:
            name: "{{ item }}"
            masked: yes
          loop:
            - systemd-rfkill.service
            - systemd-rfkill.socket
          when: tlp_check.rc == 0
          failed_when: false
          changed_when: true

        - name: Configure TLP CPU governor for AC power
          lineinfile:
            path: /etc/tlp.conf
            regexp: "^CPU_SCALING_GOVERNOR_ON_AC="
            line: 'CPU_SCALING_GOVERNOR_ON_AC="performance"'
          when: tlp_check.rc == 0
          failed_when: false
          changed_when: true

        - name: Configure TLP CPU governor for battery
          lineinfile:
            path: /etc/tlp.conf
            regexp: "^CPU_SCALING_GOVERNOR_ON_BAT="
            line: 'CPU_SCALING_GOVERNOR_ON_BAT="powersave"'
          when: tlp_check.rc == 0
          failed_when: false
          changed_when: true

        - name: Configure TLP energy policy for AC
          lineinfile:
            path: /etc/tlp.conf
            regexp: "^CPU_ENERGY_PERF_POLICY_ON_AC="
            line: 'CPU_ENERGY_PERF_POLICY_ON_AC="performance"'
          when: tlp_check.rc == 0
          failed_when: false
          changed_when: true

        - name: Configure TLP energy policy for battery
          lineinfile:
            path: /etc/tlp.conf
            regexp: "^CPU_ENERGY_PERF_POLICY_ON_BAT="
            line: 'CPU_ENERGY_PERF_POLICY_ON_BAT="power"'
          when: tlp_check.rc == 0
          failed_when: false
          changed_when: true

    - name: Enable zswap/zram for freeze prevention
      block:
        - name: Configure zram-generator
          copy:
            dest: /etc/systemd/zram-generator.conf
            content: |
              [zram0]
              zram-size = ram / 2
              compression-algorithm = lz4
              swap-priority = 100
              fs-type = swap
            mode: '0644'
          register: zram_conf
          failed_when: false
          changed_when: true

        - name: Enable and start zram-generator service
          systemd:
            name: systemd-zram-setup@zram0.service
            enabled: yes
            state: started
          when: zram_conf.changed
          failed_when: false
          changed_when: true

    - name: Apply freeze prevention sysctl
      copy:
        dest: /etc/sysctl.d/99-freeze-prevention.conf
        content: |
          kernel.sysrq=1
          kernel.nmi_watchdog=1
          kernel.watchdog_thresh=10
          kernel.hung_task_timeout_secs=120
          kernel.panic=30
          kernel.panic_on_oops=1
          kernel.softlockup_panic=1
        mode: '0644'
      register: sysctl_freeze
      failed_when: false
      changed_when: true

    - name: Reload sysctl after freeze prevention config
      command: sysctl --system
      when: sysctl_freeze.changed
      failed_when: false
      changed_when: true

    - name: Enable Hardware Watchdog modules
      copy:
        dest: /etc/modules-load.d/watchdog.conf
        content: |
          iTCO_wdt
          sp5100_tco
        mode: '0644'
      failed_when: false
      changed_when: true

    - name: Configure systemd-oomd
      block:
        - name: Configure systemd-oomd thresholds
          copy:
            dest: /etc/systemd/oomd.conf
            content: |
              [OOM]
              SwapUsedLimit=80%
              DefaultMemoryPressureLimit=60%
              DefaultMemoryPressureDurationSec=10s
            mode: '0644'
          register: oomd_conf
          failed_when: false
          changed_when: true

        - name: Enable and start systemd-oomd
          systemd:
            name: systemd-oomd.service
            enabled: yes
            state: started
            daemon_reload: yes
          failed_when: false
          changed_when: true

        - name: Set user session memory pressure monitoring
          copy:
            dest: /etc/systemd/system/user-.slice.d/99-oomd.conf
            content: |
              [Slice]
              ManagedOOMMemoryPressure=kill
              ManagedOOMMemoryPressureLimit=60%
            mode: '0644'
          register: slice_conf
          failed_when: false
          changed_when: true

        - name: Set memory ceiling on user sessions
          copy:
            dest: /etc/systemd/system/user@.service.d/99-memory-limit.conf
            content: |
              [Service]
              ManagedOOMMemoryPressure=kill
              ManagedOOMMemoryPressureLimit=60%
            mode: '0644'
          failed_when: false
          changed_when: true

        - name: Reload systemd after slice/oomd changes
          systemd:
            daemon_reload: yes
          when: slice_conf.changed or oomd_conf.changed
          failed_when: false
          changed_when: true

    - name: Protect display manager from OOM killer
      block:
        - name: Create oomscore drop-in for display manager
          file:
            path: /etc/systemd/system/gdm.service.d
            state: directory
            mode: '0755'
          failed_when: false
          changed_when: true

        - name: Protect GDM from OOM killer
          copy:
            dest: /etc/systemd/system/gdm.service.d/99-oom.conf
            content: |
              [Service]
              OOMScoreAdj=-500
            mode: '0644'
          failed_when: false
          changed_when: true

    - name: Disable GNOME Software autostart
      lineinfile:
        path: /etc/xdg/autostart/org.gnome.Software.desktop
        line: "Hidden=true"
        create: yes
      failed_when: false
      changed_when: true

- name: Optimize User Environment
  block:
    - name: Configure Safe Delete Aliases
      lineinfile:
        path: "{{ ansible_user_dir }}/.zshrc"
        line: "{{ item }}"
        create: yes
        state: present
      loop:
        - "# Safe Delete Configuration"
        - "alias rm='gio trash 2>/dev/null || /usr/bin/rm'"
        - "alias rp='/usr/bin/rm'"
