---
- name: Hide GRUB Menu
  become: true
  block:
    - name: Set GRUB timeout to 0
      replace:
        path: /boot/grub2/grub.cfg
        regexp: '^set timeout=.*'
        replace: 'set timeout=0'
      register: grub_config
      ignore_errors: yes

    - name: Make GRUB config read-only
      file:
        path: /boot/grub2/grub.cfg
        mode: '0444'
      when: grub_config.changed

- name: Rename BTRFS labels to 'fedora'
  become: true
  command: btrfs filesystem label {{ item.path }} fedora
  loop:
    - path: '/var'
    - path: '/var/home'
  ignore_errors: yes
  changed_when: false

- name: Optimize GNOME Services
  become: true
  block:
    - name: Disable unnecessary services
      systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
      loop:
        - cups.service
        - cups-browsed.service
        - avahi-daemon.service
        - avahi-daemon.socket
        - ModemManager.service
      ignore_errors: yes

    - name: Mask unnecessary services
      systemd:
        name: "{{ item }}"
        masked: yes
      loop:
        - geoclue.service
        - tracker-miner-fs-3.service
        - tracker-extract-3.service
      ignore_errors: yes

- name: Apply Kernel Optimizations (sysctl)
  become: true
  copy:
    dest: /etc/sysctl.d/99-performance.conf
    content: |
      vm.swappiness=10
      vm.vfs_cache_pressure=200
      vm.dirty_ratio=10
      vm.dirty_background_ratio=5
      vm.overcommit_memory=0
      vm.max_map_count=1048576
      vm.admin_reserve_kbytes=262144
      vm.user_reserve_kbytes=524288
      net.core.rmem_max=16777216
      net.core.wmem_max=16777216
      net.ipv4.tcp_fastopen=3
      net.ipv4.tcp_congestion_control=bbr
      net.core.default_qdisc=cake
      fs.file-max=2097152
    mode: '0644'
  register: sysctl_p

- name: Reload sysctl
  become: true
  command: sysctl --system
  when: sysctl_p.changed

- name: Enable zswap/zram for compressed in-memory swap (anti-freeze)
  become: true
  block:
    - name: Configure zswap drivers
      copy:
        dest: /etc/dracut.conf.d/zswap.conf
        content: |
          add_drivers+=" lz4 lz4_compress z3fold "
        mode: '0644'

    - name: Configure zram-generator
      copy:
        dest: /etc/systemd/zram-generator.conf
        content: |
          [zram0]
          zram-size = ram / 2
          compression-algorithm = lz4
          swap-priority = 100
          fs-type = swap
        mode: '0644'
      register: zram_conf

    - name: Enable and start zram-generator service
      systemd:
        name: systemd-zram-setup@zram0.service
        enabled: yes
        state: started
      when: zram_conf.changed

    - name: Hardened Freeze Prevention (Kernel Arguments)
      become: true
      command: >
        rpm-ostree kargs
        --append-if-missing=zswap.enabled=1
        --delete=zswap.compressor=lz4hc
        --append-if-missing=zswap.compressor=lz4
        --delete=zswap.max_pool_percent=25
        --append-if-missing=zswap.max_pool_percent=40
        --append-if-missing=zswap.zpool=z3fold
        --append-if-missing=preempt=full
        --append-if-missing=workqueue.watchdog=1
        --append-if-missing=amdgpu.lockup_timeout=1000
        --append-if-missing=nvidia.NvReg_ResmanDebugLevel=3
        --append-if-missing=i915.enable_hangcheck=1
      register: zswap_kargs
      changed_when: "'no changes' not in zswap_kargs.stderr"
      ignore_errors: yes

- name: Protect session-critical processes from OOM killer
  become: true
  copy:
    dest: /etc/systemd/system.conf.d/99-oom-protect.conf
    content: |
      [Manager]
      DefaultOOMPolicy=continue
    mode: '0644'

- name: Create oomscore drop-in for display manager
  become: true
  file:
    path: /etc/systemd/system/gdm.service.d
    state: directory
    mode: '0755'
  ignore_errors: yes

- name: Protect GDM/SDDM from OOM killer
  become: true
  copy:
    dest: /etc/systemd/system/gdm.service.d/99-oom.conf
    content: |
      [Service]
      OOMScoreAdj=-500
    mode: '0644'
  ignore_errors: yes

- name: Apply Freeze Prevention (sysctl)
  become: true
  copy:
    dest: /etc/sysctl.d/99-freeze-prevention.conf
    content: |
      kernel.sysrq=1
      kernel.nmi_watchdog=1
      kernel.watchdog_thresh=10
      kernel.hung_task_timeout_secs=120
      kernel.panic=30
      kernel.panic_on_oops=1
      kernel.softlockup_panic=1
    mode: '0644'
  register: sysctl_freeze

- name: Enable Hardware Watchdog modules
  become: true
  copy:
    dest: /etc/modules-load.d/watchdog.conf
    content: |
      # Intel TCO watchdog
      iTCO_wdt
      # AMD SP5100 TCO watchdog
      sp5100_tco
    mode: '0644'

- name: Enable Compositor Watchdog (KWin)
  become: true
  lineinfile:
    path: /etc/environment
    line: "KWIN_WATCHDOG=1"
    create: yes
    state: present

- name: Reload sysctl after freeze prevention config
  become: true
  command: sysctl --system
  when: sysctl_freeze.changed

- name: Configure systemd-oomd thresholds
  become: true
  copy:
    dest: /etc/systemd/oomd.conf
    content: |
      [OOM]
      SwapUsedLimit=80%
      DefaultMemoryPressureLimit=60%
      DefaultMemoryPressureDurationSec=10s
    mode: '0644'
  register: oomd_conf

- name: Enable and start systemd-oomd
  become: true
  systemd:
    name: systemd-oomd.service
    enabled: yes
    state: started
    daemon_reload: yes

- name: Create user slice drop-in directory
  become: true
  file:
    path: /etc/systemd/system/user-.slice.d
    state: directory
    mode: '0755'

- name: Set user session memory pressure monitoring
  become: true
  copy:
    dest: /etc/systemd/system/user-.slice.d/99-oomd.conf
    content: |
      [Slice]
      ManagedOOMMemoryPressure=kill
      ManagedOOMMemoryPressureLimit=60%
    mode: '0644'
  register: slice_conf

- name: Create user service drop-in directory
  become: true
  file:
    path: /etc/systemd/system/user@.service.d
    state: directory
    mode: '0755'

- name: Set memory ceiling on user sessions
  become: true
  copy:
    dest: /etc/systemd/system/user@.service.d/99-memory-limit.conf
    content: |
      [Service]
      ManagedOOMMemoryPressure=kill
      ManagedOOMMemoryPressureLimit=60%
    mode: '0644'

- name: Reload systemd after slice/oomd changes
  become: true
  systemd:
    daemon_reload: yes
  when: slice_conf.changed or oomd_conf.changed

- name: Configure Safe Delete Aliases
  lineinfile:
    path: "{{ ansible_user_dir }}/.zshrc"
    line: "{{ item }}"
    create: yes
    state: present
  loop:
    - "# Safe Delete Configuration (Kionite Setup)"
    - "alias rm='gio trash 2>/dev/null || /usr/bin/rm'"
    - "alias rp='/usr/bin/rm'"
